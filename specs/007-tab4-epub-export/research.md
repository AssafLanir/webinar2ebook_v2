# Research: Tab 4 EPUB Export

**Date**: 2025-12-31
**Status**: Complete

## 1. ebooklib Library Setup

**Decision**: Use ebooklib for EPUB 3.0 generation

**Rationale**: ebooklib is the most mature Python library for EPUB creation. It's pure Python (no system dependencies), well-maintained, and supports both EPUB 2.0 and 3.0.

**Installation**:
```bash
pip install ebooklib>=0.18
```

**Basic Usage**:
```python
from ebooklib import epub

# Create book
book = epub.EpubBook()
book.set_identifier('id123456')
book.set_title('My Ebook')
book.set_language('en')
book.add_author('Author Name')

# Create chapter
chapter = epub.EpubHtml(title='Chapter 1', file_name='chapter_01.xhtml', lang='en')
chapter.content = '<html><body><h1>Chapter 1</h1><p>Content here...</p></body></html>'
book.add_item(chapter)

# Add navigation
book.toc = (epub.Link('chapter_01.xhtml', 'Chapter 1', 'ch1'),)
book.add_item(epub.EpubNcx())
book.add_item(epub.EpubNav())

# Define spine (reading order)
book.spine = ['nav', chapter]

# Write EPUB file
epub.write_epub('output.epub', book)
```

**Alternatives Considered**:
- **pypub**: Simpler but less maintained, fewer features
- **manual zip**: Too low-level, would need to implement EPUB spec

---

## 2. EPUB Structure

**Decision**: Let ebooklib handle EPUB structure automatically

**Rationale**: ebooklib generates all required EPUB files (container.xml, content.opf, toc.ncx, nav.xhtml) automatically. We just need to add content items.

**EPUB Package Contents** (generated by ebooklib):
```
my-ebook.epub (ZIP archive)
├── mimetype                  # "application/epub+zip"
├── META-INF/
│   └── container.xml        # Points to content.opf
├── EPUB/
│   ├── content.opf          # Package document (manifest, spine, metadata)
│   ├── toc.ncx              # NCX navigation (EPUB 2.0 compat)
│   ├── nav.xhtml            # EPUB 3.0 navigation
│   ├── cover.xhtml          # Cover page content
│   ├── chapter_01.xhtml     # Chapter content
│   ├── chapter_02.xhtml
│   ├── styles.css           # Stylesheet
│   └── images/
│       ├── image1.jpg
│       └── image2.png
```

**Key Points**:
- ebooklib handles mimetype, META-INF, and content.opf automatically
- We create EpubHtml items for chapters and EpubImage items for images
- TOC is set via `book.toc` property
- Spine defines reading order via `book.spine`

---

## 3. Image Embedding

**Decision**: Add images as EpubImage items with relative paths in chapter HTML

**Rationale**: EPUB stores images as separate files in the package (unlike PDF where we use base64). ebooklib handles the packaging; we just need to add images and reference them correctly.

**Implementation Pattern**:
```python
from ebooklib import epub

# Add image to EPUB
image_item = epub.EpubImage()
image_item.file_name = 'images/figure1.jpg'
image_item.media_type = 'image/jpeg'
image_item.content = image_bytes  # Raw bytes from GridFS
book.add_item(image_item)

# Reference in chapter HTML
chapter.content = '''
<html>
<body>
<h1>Chapter 1</h1>
<figure>
  <img src="images/figure1.jpg" alt="Figure description" />
  <figcaption>Figure 1: Caption text</figcaption>
</figure>
</body>
</html>
'''
```

**Image Format Requirements**:
- EPUB supports: JPEG, PNG, GIF, SVG
- Our assets are already JPEG/PNG (from Pillow processing in Spec 005)
- Media types: `image/jpeg`, `image/png`

**Image Path Strategy**:
- Store all images in `images/` directory within EPUB
- Use unique filenames: `{asset_id}.{extension}`
- Reference with relative paths: `images/abc123.jpg`

---

## 4. TOC/Navigation Generation

**Decision**: Build TOC from markdown headings, create EpubNav

**Rationale**: ebooklib provides EpubNav for EPUB 3.0 navigation and EpubNcx for EPUB 2.0 compatibility. We parse headings from markdown and build the TOC structure.

**Implementation Pattern**:
```python
from ebooklib import epub

# Build TOC from chapters
toc_items = []
for chapter in chapters:
    toc_items.append(epub.Link(
        chapter.file_name,  # e.g., 'chapter_01.xhtml'
        chapter.title,      # e.g., 'Introduction'
        chapter.get_id()    # unique ID
    ))

# Set TOC (can be nested for subsections)
book.toc = tuple(toc_items)

# Add required navigation items
book.add_item(epub.EpubNcx())  # EPUB 2.0 NCX
book.add_item(epub.EpubNav())  # EPUB 3.0 Nav

# Include nav in spine
book.spine = ['nav'] + chapter_list
```

**Nested TOC** (for H2 subheadings):
```python
# For nested structure
book.toc = (
    epub.Link('ch1.xhtml', 'Chapter 1', 'ch1'),
    (
        epub.Section('Chapter 2'),
        (
            epub.Link('ch2.xhtml', 'Section 2.1', 'sec21'),
            epub.Link('ch2_2.xhtml', 'Section 2.2', 'sec22'),
        )
    ),
)
```

**For MVP**: Flat TOC with H1 chapters only (consistent with PDF behavior).

---

## 5. CSS for E-readers

**Decision**: Use minimal, e-reader-compatible CSS

**Rationale**: E-readers vary widely in CSS support. Keep styling minimal and let the reader app handle fonts/sizes. Focus on structure and spacing.

**EPUB Stylesheet**:
```css
/* Basic reset and typography */
body {
  font-family: serif;
  line-height: 1.6;
  margin: 1em;
}

/* Headings */
h1 {
  font-size: 1.5em;
  margin-top: 2em;
  margin-bottom: 0.5em;
  page-break-before: always;
}

h2 {
  font-size: 1.2em;
  margin-top: 1.5em;
  margin-bottom: 0.3em;
}

/* Cover page */
.cover {
  text-align: center;
  margin-top: 30%;
}

.cover h1 {
  font-size: 2em;
  page-break-before: avoid;
}

.cover .subtitle {
  font-size: 1.2em;
  color: #666;
  margin-top: 0.5em;
}

.cover .credits {
  font-size: 0.9em;
  color: #888;
  margin-top: 3em;
}

/* Images */
figure {
  text-align: center;
  margin: 1.5em 0;
  page-break-inside: avoid;
}

figure img {
  max-width: 100%;
  height: auto;
}

figcaption {
  font-size: 0.85em;
  color: #666;
  margin-top: 0.5em;
  font-style: italic;
}

/* Paragraphs */
p {
  margin: 0.5em 0;
  text-indent: 1em;
}

p:first-of-type {
  text-indent: 0;
}

/* Lists */
ul, ol {
  margin: 1em 0;
  padding-left: 2em;
}

/* Code blocks */
pre, code {
  font-family: monospace;
  font-size: 0.9em;
  background-color: #f5f5f5;
}

pre {
  padding: 0.5em;
  overflow-x: auto;
}
```

**CSS Best Practices for EPUB**:
- Use relative units (em, %) not pixels
- Avoid fixed positioning
- Use `page-break-*` for chapter breaks
- Keep colors simple (some e-readers are grayscale)
- Don't rely on web fonts (may not load)

---

## 6. WebP to JPEG/PNG Conversion

**Decision**: Convert WebP images to JPEG (or PNG if alpha channel) before embedding in EPUB

**Rationale**: EPUB 3.0 spec requires JPEG, PNG, GIF, or SVG. WebP is allowed in Tab 2 uploads (Spec 005) but not universally supported by EPUB readers (especially older Kindle devices and some e-ink readers).

**Implementation Pattern**:
```python
from PIL import Image
import io

def convert_for_epub(image_bytes: bytes, mime_type: str) -> tuple[bytes, str]:
    """
    Convert image to EPUB-compatible format if needed.

    Returns:
        tuple of (converted_bytes, new_mime_type)
    """
    if mime_type in ('image/jpeg', 'image/png', 'image/gif'):
        return image_bytes, mime_type

    # Convert WebP or other formats
    img = Image.open(io.BytesIO(image_bytes))
    output = io.BytesIO()

    # Use PNG if image has alpha channel, otherwise JPEG
    if img.mode in ('RGBA', 'LA') or (img.mode == 'P' and 'transparency' in img.info):
        img.save(output, format='PNG', optimize=True)
        return output.getvalue(), 'image/png'
    else:
        # Convert to RGB for JPEG (handles RGBA, P, etc.)
        if img.mode != 'RGB':
            img = img.convert('RGB')
        img.save(output, format='JPEG', quality=85, optimize=True)
        return output.getvalue(), 'image/jpeg'
```

**Image Size Optimization**:
```python
MAX_DIMENSION = 1600  # Max width or height for EPUB images

def optimize_image_size(img: Image.Image) -> Image.Image:
    """Downscale large images for reasonable EPUB file size."""
    if max(img.size) > MAX_DIMENSION:
        img.thumbnail((MAX_DIMENSION, MAX_DIMENSION), Image.Resampling.LANCZOS)
    return img
```

**Key Points**:
- WebP → JPEG (no alpha) or PNG (has alpha)
- Downscale images > 1600px to keep EPUB size reasonable
- Use Pillow (already a project dependency)
- Preserve aspect ratio during resize

---

## 7. EPUB Validation

**Decision**: Validate with epubcheck during development, skip runtime validation

**Rationale**: epubcheck is the standard EPUB validator but it's a Java tool. Use it during development to ensure our output is valid, but don't require it at runtime.

**Development Validation**:
```bash
# Install epubcheck (requires Java)
# macOS: brew install epubcheck
# Ubuntu: apt install epubcheck

# Validate generated EPUB
epubcheck output.epub
```

**Common Validation Issues to Avoid**:
- Missing required metadata (title, identifier, language)
- Incorrect media types
- Missing items in manifest
- Invalid XHTML (use proper XML escaping)
- Missing navigation documents

**Our Approach**:
- ebooklib handles most structure requirements
- Use Python `html` module for proper escaping
- Test with epubcheck during development
- Don't include epubcheck as runtime dependency

---

## Summary

All unknowns resolved. Ready for Phase 1 design artifacts:

| Topic | Decision |
|-------|----------|
| EPUB Library | ebooklib (pure Python, well-maintained) |
| EPUB Structure | Let ebooklib handle (OPF, NCX, etc.) |
| Image Embedding | EpubImage items with relative paths |
| Image Conversion | WebP → JPEG/PNG via Pillow; downscale >1600px |
| TOC Generation | Build from H1 headings, flat structure for MVP |
| CSS Styling | Minimal e-reader-compatible CSS |
| Validation | epubcheck for dev, not runtime |
